{% extends "dashboard_base.html" %}

{% block title %}Students - Attendify{% endblock %}

{% block dashboard_content %}
<h1 class="mb-4 text-center">Manage Students</h1>


<div class="d-flex justify-content-between mb-3 text-end">
  <!-- Single Form for Class and Sort By -->
  <form method="get" action="" class="d-flex align-items-center">
    <select name="class" class="form-select me-2" onchange="this.form.submit()">
      <option value="" {% if not selected_class_id %}selected{% endif %}>All Classes</option>
      {% for class in classes %}
        <option value="{{ class.id }}" {% if class.id|stringformat:'s' == selected_class_id %}selected{% endif %}>{{ class.name }}</option>
      {% endfor %}
    </select>
    <select name="sort_by" id="sort_by" class="form-select me-2" onchange="this.form.submit()">
      <option value="" disabled {% if not request.GET.sort_by %}selected{% endif %}>Sort By</option>
      <option value="id" {% if request.GET.sort_by == 'id' %}selected{% endif %}>ID</option>
      <option value="name" {% if request.GET.sort_by == 'name' %}selected{% endif %}>Name</option>
      <option value="roll_number" {% if request.GET.sort_by == 'roll_number' %}selected{% endif %}>Roll No</option>
      <option value="created_at" {% if request.GET.sort_by == 'created_at' %}selected{% endif %}>Created At</option>
    </select>
  </form>
  <div class="d-flex">
    <button class="btn btn-success me-2" type="button" data-bs-toggle="modal" data-bs-target="#addStudentModal">Add New Student</button>
    <button class="btn btn-primary" type="button" data-bs-toggle="modal" data-bs-target="#importStudentsModal">Import from XLSX</button>
  </div>
</div>

<!-- List of Students -->
<div class="table-responsive table_data">
    <table class="table table-dark table-striped">
        <thead>
            <tr>
                <th>ID</th>
                <th>Name</th>
                <th>Class</th>
                <th>Roll No</th>
                <th>Created At</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for student in students %}
            <tr>
                <td>{{ student.id }}</td>
                <td>{{ student.name }}</td>
                <td>{% if student.student_class %}{{ student.student_class.name }}{% else %}N/A{% endif %}</td>
                <td>{{ student.roll_number }}</td>
                <td>{{ student.created_at|date:'Y-m-d' }}</td>
                <td>
                    <button type="button" class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editStudentModal" data-student-id="{{ student.id }}" data-student-name="{{ student.name }}" data-student-class="{% if student.student_class %}{{ student.student_class.id }}{% endif %}" data-student-roll="{{ student.roll_number }}">Edit</button>
                    <form method="post" action="" style="display:inline;">
                        {% csrf_token %}
                        <input type="hidden" name="action" value="delete">
                        <input type="hidden" name="student_id" value="{{ student.id }}">
                        <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Are you sure you want to delete this student?');">Delete</button>
                    </form>
                </td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-center">No students found.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Student Modal -->
<div class="modal fade" id="addStudentModal" tabindex="-1" aria-labelledby="addStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="addStudentModalLabel">Add New Student</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="add">
        <div class="modal-body">
          <div class="mb-3">
            <label for="add_name" class="form-label">Name</label>
            <input type="text" id="add_name" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="add_class" class="form-label">Class</label>
            <select id="add_class" name="class" class="form-select" required>
              <option value="" disabled selected>Select Class</option>
              {% for class in classes %}
              <option value="{{ class.id }}">{{ class.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="add_roll_no" class="form-label">Roll No</label>
            <input type="number" id="add_roll_no" name="roll_no" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="add_image" class="form-label">Image</label>
            <input type="file" id="add_image" name="image" class="form-control" accept="image/jpeg">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Add Student</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Import Students Modal -->
<div class="modal fade" id="importStudentsModal" tabindex="-1" aria-labelledby="importStudentsModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="importStudentsModalLabel">Import Students from XLSX</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="import_xlsx">
        <div class="modal-body">
          <div class="alert alert-info bg-info text-dark">
            <strong>Instructions:</strong><br>
            Please upload an <b>XLSX</b> file with the following columns (header row required):<br>
            <ul>
              <li><b>Name</b> (Student's name)</li>
              <li><b>Class</b> (Class name, must match an existing class)</li>
              <li><b>Roll No</b> (Roll number)</li>
            </ul>
            <b>Example:</b><br>
            <code>Name | Class | Roll No</code><br>
            <code>John Doe | Class 1 | 1</code>
          </div>
          <div class="mb-3">
            <label for="import_xlsx_file" class="form-label">Select XLSX File</label>
            <input type="file" id="import_xlsx_file" name="xlsx_file" class="form-control" accept=".xlsx" required>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Import Students</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" id="editStudentModal" tabindex="-1" aria-labelledby="editStudentModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content bg-dark text-light">
      <div class="modal-header">
        <h5 class="modal-title" id="editStudentModalLabel">Edit Student</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="post" action="" enctype="multipart/form-data">
        {% csrf_token %}
        <input type="hidden" name="action" value="edit">
        <input type="hidden" id="edit_student_id" name="student_id">
        <div class="modal-body">
          <div class="mb-3">
            <label for="edit_name" class="form-label">Name</label>
            <input type="text" id="edit_name" name="name" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit_class" class="form-label">Class</label>
            <select id="edit_class" name="class" class="form-select" required>
              <option value="" disabled selected>Select Class</option>
              {% for class in classes %}
              <option value="{{ class.id }}">{{ class.name }}</option>
              {% endfor %}
            </select>
          </div>
          <div class="mb-3">
            <label for="edit_roll_no" class="form-label">Roll No</label>
            <input type="number" id="edit_roll_no" name="roll_no" class="form-control" required>
          </div>
          <div class="mb-3">
            <label for="edit_image" class="form-label">Image</label>
            <input type="file" id="edit_image" name="image" class="form-control" accept="image/jpeg">
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-success">Update Student</button>
        </div>
      </form>
    </div>
  </div>
</div>

<script>
// Fill edit modal with student data
const editModal = document.getElementById('editStudentModal');
editModal.addEventListener('show.bs.modal', function (event) {
  const button = event.relatedTarget;
  document.getElementById('edit_student_id').value = button.getAttribute('data-student-id');
  document.getElementById('edit_name').value = button.getAttribute('data-student-name');
  document.getElementById('edit_roll_no').value = button.getAttribute('data-student-roll');
  const classId = button.getAttribute('data-student-class');
  const classSelect = document.getElementById('edit_class');
  for (let i = 0; i < classSelect.options.length; i++) {
    classSelect.options[i].selected = classSelect.options[i].value == classId;
  }
});
</script>
{% endblock %}
