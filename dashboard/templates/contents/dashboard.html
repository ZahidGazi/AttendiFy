{% extends "dashboard_base.html" %}
{% load static %}

{% block title %}Dashboard - Attendify{% endblock %}

{% block dashboard_content %}
<h1 class="mb-4 text-center">Welcome {{ request.user.username }} </h1>
<div class="mb-4">
    <form method="get" class="d-flex align-items-center">
        <label for="class-select" class="me-2 text-bold">Select Class:</label>
        <select id="class-select" name="class" class="form-select w-auto me-2">
            <option value="">All Classes</option>
            {% for class in classes %}
                <option value="{{ class.id }}" {% if class.id|stringformat:'s' == selected_class_id %}selected{% endif %}>{{ class.name }}</option>
            {% endfor %}
        </select>
        <button type="submit" class="btn btn-primary">View</button>
    </form>
</div>
<div class="row justify-content-center">
    <div class="col-md-3">
        <div class="card text-center shadow-sm bg-dark text-light">
            <div class="card-body">
                <h5 class="card-title">Total Students Registered</h5>
                <p class="card-text display-6">{{ total_students }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm bg-dark text-light">
            <div class="card-body">
                <h5 class="card-title">Today's Attendance Count</h5>
                <p class="card-text display-6">{{ today_attendance }}</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card text-center shadow-sm bg-dark text-light">
            <div class="card-body">
                <h5 class="card-title">Absent Students Today</h5>
                <p class="card-text display-6">{{ absent_today }}</p>
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-8 mb-4">
        <div class="card p-3 bg-dark text-light">
            <h5 class="card-title">Attendance Trend (Past 7 Days)</h5>
            <div id="attendanceTrendChart" style="height:400px;"></div>
        </div>
    </div>
    <div class="col-md-4 mb-4">
        <div class="card p-3 bg-dark text-light">
            <h5 class="card-title">Today's Attendance Breakdown</h5>
            <div id="attendancePieChart" style="height:400px;"></div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-6 mb-4">
        <div class="card p-3 bg-dark text-light">
            <h5 class="card-title">Top 3 Students (Best Attendance)</h5>
            <ul class="list-group list-group-flush">
                {% for student in top_students %}
                    <li class="list-group-item bg-dark text-light">{{ student.name }} - {{ student.presents }} presents</li>
                {% empty %}
                    <li class="list-group-item bg-dark text-light">No data</li>
                {% endfor %}
            </ul>
        </div>
    </div>
    <div class="col-md-6 mb-4">
        <div class="card p-3 bg-dark text-light">
            <h5 class="card-title">Frequent Absentees</h5>
            <ul class="list-group list-group-flush">
                {% for student in frequent_absentees %}
                    <li class="list-group-item bg-dark text-light">{{ student.name }} - {{ student.absents }} absences</li>
                {% empty %}
                    <li class="list-group-item bg-dark text-light">No data</li>
                {% endfor %}
            </ul>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<script src="https://cdn.plot.ly/plotly-latest.min.js"></script>

{# Pass data safely to JS #}
{{ week_days_labels|json_script:"week-days-labels" }}
{{ attendance_trend|json_script:"attendance-trend" }}
{{ pie_data|json_script:"pie-data" }}

<script>
const weekDaysLabels = JSON.parse(document.getElementById('week-days-labels').textContent);
const attendanceTrend = JSON.parse(document.getElementById('attendance-trend').textContent);
const pieData = JSON.parse(document.getElementById('pie-data').textContent);

// Line chart (Attendance Trend)
Plotly.newPlot('attendanceTrendChart', [{
    x: weekDaysLabels,
    y: attendanceTrend,
    type: 'scatter',
    mode: 'lines+markers',
    line: { color: '#4f8cff', width: 3 },
    fill: 'tozeroy',
    fillcolor: 'rgba(79,140,255,0.2)',
    marker: { color: '#4f8cff' },
    name: 'Attendance'
}], {
    margin: { t: 30, l: 40, r: 10, b: 40 },
    paper_bgcolor: '#212529',
    plot_bgcolor: '#212529',
    font: { color: '#fff' },
    xaxis: { title: '', tickfont: { color: '#fff' }, gridcolor: '#444' },
    yaxis: { title: '', tickfont: { color: '#fff' }, gridcolor: '#444' },
    showlegend: false
}, {responsive: true});

// Pie chart (Today's Attendance Breakdown)
Plotly.newPlot('attendancePieChart', [{
    values: pieData,
    labels: ['Present', 'Absent'],
    type: 'pie',
    marker: { colors: ['#4caf50', '#f44336'] }
}], {
    margin: { t: 30, l: 10, r: 10, b: 10 },
    paper_bgcolor: '#212529',
    font: { color: '#fff' },
    legend: { orientation: 'h', y: -0.1 }
}, {responsive: true});
</script>
{% endblock %}

